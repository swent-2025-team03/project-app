rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    function isSignedIn() {
      return request.auth != null;
    }

    function myUser() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data;
    }

    function userDoc(uid) {
      return firestore.get(/databases/(default)/documents/users/$(uid)).data;
    }

    function officeDoc(officeId) {
      return firestore.get(/databases/(default)/documents/offices/$(officeId)).data;
    }

    function reportDoc(reportId) {
      return firestore.get(/databases/(default)/documents/reports/$(reportId)).data;
    }

    function hasRole(role) {
      return isSignedIn() && myUser().role == role;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function underMax(bytes) {
      return request.resource.size < bytes;
    }

    match /users/{userId}/{allPaths=**} {
      allow read: if isSignedIn() && (
        userId == request.auth.uid
        ||
        (
          hasRole("Vet") && (
            (userDoc(userId).role == "Vet" && userDoc(userId).officeId == myUser().officeId)
            ||
            (userDoc(userId).role == "Farmer" && myUser().officeId in userDoc(userId).linkedOffices)
          )
        )
        ||
        (
          hasRole("Farmer")
          && userDoc(userId).role == "Vet"
          && userDoc(userId).officeId in myUser().linkedOffices
        )
      );

      allow write: if isOwner(userId) && underMax(5 * 1024 * 1024);
    }

    match /offices/{officeId}/{allPaths=**} {
      allow read: if isSignedIn() && (
        (hasRole("Vet") && myUser().officeId == officeId)
        ||
        (hasRole("Farmer") && officeId in myUser().linkedOffices)
      );

     allow write: if isSignedIn()
        && hasRole("Vet")
        && myUser().officeId == officeId
        && officeDoc(officeId).ownerId == request.auth.uid
        && underMax(10 * 1024 * 1024);
    }

    match /reports/{reportId}/{allPaths=**} {
      allow read: if isSignedIn() && (
        (hasRole("Vet") && reportDoc(reportId).officeId == myUser().officeId)
        ||
        (hasRole("Farmer") && reportDoc(reportId).farmerId == request.auth.uid)
      );

     allow write: if isSignedIn()
        && underMax(10 * 1024 * 1024)
        && (
          (hasRole("Farmer") && reportDoc(reportId).farmerId == request.auth.uid)
          ||
          (hasRole("Vet") && reportDoc(reportId).officeId == myUser().officeId)
        );
    }

    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
